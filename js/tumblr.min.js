!function(e,t){"use strict";function s(e,t,s){var a=s-t+1,o=new Array(a),r=[],n=0,i=0;if(0==t){if(e>s+1)return}else if(e>s-t+1)return;for(n=0;a>n;n++)o[n]=n+t;for(i=0;e>i;i++){var p=Math.floor(Math.random()*o.length);r.push(o[p]),o.splice(p,1)}return r}var a=function(s){this.params=e.extend({useAPI:!1,versionAPI:1,keyAPI:"",limitData:250,cache:!1,cacheMethod:"sessionStorage",wrapperSelector:"",postSelector:".post",appendMethod:"normal",nearBottom:350,debug:!1},s||{}),this.baseURL="//"+t.location.host,this.infiniteScroll=!0,this.endPage=!1,this.isLoading=!1,this.jsonComplete=!1,this.currentPage=1,this.totalPages=totalPages,this.$win=e(t),this.$doc=e(document),this.handlers={},this.init()};a.prototype.init=function(){var e=this;return this.params.useAPI&&this.getAllData(),document.all&&!document.addEventListener&&8==document.documentMode?void(this.infiniteScroll=!1):void this.$win.on("scroll",function(){e.trigger(e.events.ON_SCROLL),e.onScroll()})},a.prototype.on=function(e,t){var s=this;this.handlers[t]=function(){t.call(s)},this.$doc.on(e,this.handlers[t])},a.prototype.off=function(e,t){this.$doc.off(e,this.handlers[t])},a.prototype.trigger=function(e,t){this.$doc.trigger(e,"undefined"!=typeof t?t:[])},a.prototype.events={ON_SCROLL:"onWindowScroll",JSON_COMPLETE:"onJsonComplete",START_LOADING:"startLoading",END_LOADING:"endLoading",END_PAGE:"onEndedPage",IMAGES_LOADED:"onImagesLoaded",POST_APPEND:"onPostAppended",NO_RELATED:"noRelated",HAS_RELATED:"hasRelated",ON_RECEIVE_NEW_POST:"onReceiveNewPost"},a.prototype.getAllData=function(e){var s=this,a=t[this.params.cacheMethod];if("undefined"!=typeof a&&this.params.cache){var o=a.getItem("TUMBLR_JSON_DATA");null==o?(this.getDataFromAPI(),this.on(this.events.JSON_COMPLETE,function(){try{a.setItem("TUMBLR_JSON_DATA",JSON.stringify(this.data))}catch(e){22==e.code&&(s.log("JSON is too big and can't store in web storage, please pass cache params to false or reduice limitData"),a.removeItem("TUMBLR_JSON_DATA"))}})):(this.data=JSON.parse(a.getItem("TUMBLR_JSON_DATA")),this.totalPost=this.data["posts-total"],this.jsonComplete=!0,setTimeout(function(){s.trigger(s.events.JSON_COMPLETE)},0))}else this.getDataFromAPI(),sessionStorage.removeItem("TUMBLR_JSON_DATA"),localStorage.removeItem("TUMBLR_JSON_DATA")},a.prototype.getDataFromAPI=function(){var s=this,a=0,o="";1==this.params.versionAPI?(a=50,o=this.baseURL+"/api/read/json?callback=?&num="+a):2==this.params.versionAPI&&(a=50,o="//api.tumblr.com/v2/blog/"+t.location.host+"/posts/?api_key="+this.params.keyAPI+"&limit="+a+"&notes_info=false&callback=?"),e.getJSON(o,function(t){var r=0,n=0,i=0;if(2==s.params.versionAPI&&0==t.response.length)return void s.log("Tumblr API V2 is unavailable in private blog. Please use API V1 or remove password blog.");if(s.data=1==s.params.versionAPI?t:t.response,s.totalPost=1==s.params.versionAPI?t["posts-total"]:t.response.total_posts,r=s.totalPost<=s.params.limitData?Math.ceil((s.totalPost-a)/a):Math.ceil((s.params.limitData-a)/a),0>=r)s.jsonComplete=!0,s.trigger(s.events.JSON_COMPLETE);else for(var p=0;r>p;p++)!function(t){n=a+a*t,e.getJSON(o+(1==s.params.versionAPI?"&start=":"&offset=")+n,function(e){for(var t=parseInt(s.data.posts.length),a=0,o=1==s.params.versionAPI?e.posts.length:e.response.posts.length;o>a;a++)s.data.posts[t+parseInt(a)]=1==s.params.versionAPI?e.posts[a]:e.response.posts[a];i++,i==r&&(s.jsonComplete=!0,s.trigger(s.events.JSON_COMPLETE))})}(p)})},a.prototype.onScroll=function(t){function s(){r===!0&&n===!0&&(a.trigger(a.events.IMAGES_LOADED),a.trigger(a.events.END_LOADING))}var a=this,o=null,r=!1,n=!1;if(!this.isLoading&&this.infiniteScroll&&!this.endPage&&("home"==this.checkPage()||"tagged"==this.checkPage())&&this.$win.scrollTop()>=this.$doc.height()-this.$win.height()-this.params.nearBottom){if(this.trigger(this.events.START_LOADING),this.isLoading=!0,"object"==typeof this.params.wrapperSelector&&2==this.params.wrapperSelector.length&&(0==e(this.params.wrapperSelector[0]).length||0==e(this.params.wrapperSelector[1]).length))return void a.log("Containers for new post doesn't exist. Please create HTML element : "+this.params.wrapperSelector[0]+" or "+this.params.wrapperSelector[1]);if("string"==typeof this.params.wrapperSelector&&0==e(this.params.wrapperSelector).length)return void a.log("The container for new post doesn't exist. Please create HTML element : "+this.params.wrapperSelector);this.currentPage>=this.totalPages?(this.isLoading=!1,this.endPage=!0,this.trigger(this.events.END_PAGE,[{appended:!1}]),this.trigger(this.events.END_LOADING)):(o="tagged"==this.checkPage()?this.getPostOfPage(this.currentPage+1,!0):this.getPostOfPage(this.currentPage+1,!1),e(document).on(this.events.ON_RECEIVE_NEW_POST,function(t,o){0!=o&&(a.currentPage++,"normal"==a.params.appendMethod?("object"==typeof a.params.wrapperSelector&&2==a.params.wrapperSelector.length?(e(a.params.wrapperSelector[0]).append(o[0]),e(a.params.wrapperSelector[1]).append(o[1])):"string"==typeof a.params.wrapperSelector&&e(a.params.wrapperSelector).append(o),a.trigger(a.events.POST_APPEND)):("isotope"==a.params.appendMethod||"masonry"==a.params.appendMethod)&&("string"==typeof a.params.wrapperSelector?e(a.params.wrapperSelector).append(o):a.log("You can't use appendMethod isotope or masonry with two targetPost. Please use normal append method or change target post. ")),Tumblr.LikeButton.get_status_by_page(a.currentPage),"undefined"!=typeof e.fn.imagesLoaded?"object"==typeof a.params.wrapperSelector&&2==a.params.wrapperSelector.length?"normal"==a.params.appendMethod?(e(a.params.wrapperSelector[0]).imagesLoaded(function(){r=!0,s()}),e(a.params.wrapperSelector[1]).imagesLoaded(function(){n=!0,s()})):a.log("You can't use appendMethod isotope or masonry with two targetPost. Please use normal append method or change target post. "):"string"==typeof a.params.wrapperSelector&&e(a.params.wrapperSelector).imagesLoaded(function(){"isotope"==a.params.appendMethod?"undefined"!=typeof e.fn.isotope&&e(a.params.wrapperSelector).isotope("appended",o,function(){a.trigger(a.events.POST_APPEND)}):"masonry"==a.params.appendMethod&&"undefined"!=typeof e.fn.masonry&&(e(a.params.wrapperSelector).masonry("appended",o),a.trigger(a.events.POST_APPEND)),a.trigger(a.events.IMAGES_LOADED),a.trigger(a.events.END_LOADING)}):("normal"==a.params.appendMethod?a.log("jQuery.imagesLoaded.js plugins is not found. It necessary to subscribe : _Tumblr.events.IMAGES_LOADED "):a.log("jQuery.imagesLoaded.js plugins is not found. The grid use "+a.params.appendMethod+" plugin and it necessary to subscribe : _Tumblr.events.IMAGES_LOADED "),a.trigger(a.events.END_LOADING)),a.isLoading=!1,a.off(a.events.ON_RECEIVE_NEW_POST))}))}},a.prototype.getPostOfPage=function(t,s){var a=this,o=null,r=null,n=null,i=null;return t>totalPages?!1:(i=s?this.baseURL+"/tagged/"+this.getTagPage()+"/page/"+t:this.baseURL+"/page/"+t,void e.ajax({url:i,type:"post",success:function(t){"object"==typeof a.params.wrapperSelector&&2==a.params.wrapperSelector.length?(r=e(t).find(a.params.wrapperSelector[0]+" "+a.params.postSelector),n=e(t).find(a.params.wrapperSelector[1]+" "+a.params.postSelector),a.trigger(a.events.ON_RECEIVE_NEW_POST,[{0:r,1:n}])):"string"==typeof a.params.wrapperSelector&&(o=e(t).find(a.params.postSelector),a.trigger(a.events.ON_RECEIVE_NEW_POST,[o]))}}))},a.prototype.getRelatedPosts=function(t){var a=[],o=[],r=[],n=[],i=0,p=[],l=null,g=e.extend({limit:3,ignoreTag:null},t||{});if(!this.params.useAPI)return void this.log("Related post use API, please active useAPI in params.");if("post"!=this.checkPage()||!this.jsonComplete)return void this.log("Related post can only be add on post page when _Tumblr.events.JSON_COMPLETE is published");if(p=this.getTagsPost(),null==p)return this.log("The current post ("+this.getIdPostPage()+") has no tag"),void this.trigger(this.events.NO_RELATED);if(null!=g.ignoreTag&&p.length>1)for(var h=0,c=p.length;c>h;h++)g.ignoreTag==p[h]&&p.splice(h,1);i=this.getIdPostPage();for(var d=0,u=this.data.posts.length;u>d;d++)if(l=this.data.posts[d],"undefined"!=typeof l.tags)for(var m=0,f=l.tags.length;f>m;m++)for(var P=0,v=p.length;v>P;P++)l.tags[m].toLowerCase()==p[P].toLowerCase()&&l.id!=i&&-1==e.inArray(l.id,o)&&(a.push(l),o.push(l.id));if(!(a.length<1)){if(n=s(g.limit,0,parseInt(a.length)-1),a.length<g.limit)r.posts=a;else{r.posts=[];for(var h=0,S=n.length;S>h;h++)r.posts.push(a[n[h]])}return this.trigger(this.events.HAS_RELATED),r}this.trigger(this.events.NO_RELATED)},a.prototype.getAllTags=function(t){if(!this.params.useAPI)return void this.log("List of all tags use API, please active useAPI in params.");if(!this.jsonComplete)return void this.log("The function getAllTags() use JSON data, please attach to _Tumblr.events.JSON_COMPLETE event to execute your code");for(var s=this.data,a=[],o=0,r=s.posts.length;r>o;o++)if("undefined"!=typeof s.posts[o].tags)for(var n=0,i=s.posts[o].tags.length;i>n;n++)-1==e.inArray(s.posts[o].tags[n].toLowerCase(),a)&&a.push(s.posts[o].tags[n].toLowerCase());return a.sort(),a},a.prototype.getTagsPost=function(e){if(!this.params.useAPI)return void this.log("List of tags of posts use API, please active useAPI in params.");var t=[];if("undefined"==typeof e)var e=this.getIdPostPage();for(var s=0,a=this.data.posts.length;a>s;s++){if(this.data.posts[s].id==e){if("undefined"==typeof this.data.posts[s].tags)return;for(var o=0,r=this.data.posts[s].tags.length;r>o;o++)t.push(this.data.posts[s].tags[o].toLowerCase());return t}if(s==a-1)return this.log("Unknown idPost"),null}},a.prototype.getTagPage=function(e){if("tagged"==this.checkPage()){var s="";s=""==t.location.hash?t.location.pathname:t.location.hash;var a=s.split("/"),o=a[a.length-1];return decodeURIComponent(o.replace(/-/g," "))}},a.prototype.getIdPostPage=function(e){var s=t.location.href,a=null;return"post"==this.checkPage()?(s.replace(/\/post\/([0-9]+)/g,function(e,t){a=t}),a):void 0},a.prototype.checkPage=function(e){var s="";return s=""==t.location.hash?t.location.pathname:t.location.hash,-1!=s.indexOf("tagged/")?"tagged":-1!=s.indexOf("post/")?"post":"/"==s?"home":void 0},a.prototype.disableInfiniteScroll=function(e){this.infiniteScroll=!1},a.prototype.enableInfiniteScroll=function(e){this.infiniteScroll=!0},a.prototype.log=function(e){this.params.debug&&t.console&&console.log&&console.warn(e)},t._Tumblr=a}(jQuery,window);
